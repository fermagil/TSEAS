<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Plato Interactivo con Nutrici√≥n</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* General styles */
        body {
            font-family: 'Inter', sans-serif; /* Use Inter font */
            background-color: #f7fafc; /* gray-100 background */
        }
        /* Plate container styling */
        .plate-container {
            position: relative; /* Needed for absolute positioning of sections */
            width: 500px; /* Fixed width */
            height: 500px; /* Fixed height */
            max-width: 90vw; /* Max width relative to viewport */
            max-height: 90vw; /* Max height relative to viewport */
            aspect-ratio: 1 / 1; /* Maintain square shape */
            border-radius: 50%; /* Make it circular */
            overflow: hidden; /* Clip content outside the circle */
            border: 4px solid #a0aec0; /* gray-500 border */
            margin: 2rem auto; /* Center the plate */
            background-color: #edf2f7; /* gray-200 background */
        }
        /* Individual plate sections */
        .plate-section {
            position: absolute; /* Position relative to the container */
            width: 50%; /* Each section takes half width */
            height: 50%; /* Each section takes half height */
            padding: 15px; /* Inner spacing */
            overflow: hidden; /* Hide overflow */
            box-sizing: border-box; /* Include padding and border in element's total width and height */
            border: 1px solid #e2e8f0; /* gray-300 border */
        }
        /* Titles within plate sections */
        .plate-section h3 {
            position: absolute; /* Position relative to the section */
            font-weight: bold;
            font-size: 1.1rem;
            text-align: center;
            z-index: 2; /* Ensure title is above list */
            background-color: transparent; /* No background */
            transform: translate(-50%, -50%); /* Center the title precisely */
            width: 80%; /* Limit title width */
            pointer-events: none; /* Allow clicks to pass through the title */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2); /* Subtle text shadow */
        }
        /* Specific title positions and colors */
        #vegetables-section h3 { top: 35%; left: 60%; color: #276749; } /* Dark Green */
        #fruits-section h3 { top: 15%; left: 60%; color: #9b2c2c; }   /* Dark Red */
        #grains-section h3 { top: 35%; left: 40%; color: #b7791f; }     /* Dark Yellow/Brown */
        #protein-section h3 { top: 15%; left: 40%; color: #c05621; }    /* Dark Orange */

        /* Lists within plate sections */
        .plate-section ul {
            position: absolute; /* Position relative to the section */
            list-style: none; /* Remove default bullets */
            padding: 0;
            margin: 0;
            width: auto; /* Auto width based on content */
            max-width: 85%; /* Prevent list from overflowing section width */
            overflow-y: auto; /* Enable vertical scroll if needed */
            font-size: 0.9rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3); /* Subtle text shadow */
            color: #2d3748; /* gray-800 text color */
            text-align: left; /* Align list items to the left */
            scrollbar-width: thin; /* Thin scrollbar for Firefox */
            scrollbar-color: #a0aec0 #e2e8f0; /* Scrollbar colors */
            /* Webkit scrollbar styling (optional) */
            &::-webkit-scrollbar {
                width: 8px;
            }
            &::-webkit-scrollbar-track {
                background: #e2e8f0; /* gray-300 */
                border-radius: 4px;
            }
            &::-webkit-scrollbar-thumb {
                background-color: #a0aec0; /* gray-500 */
                border-radius: 4px;
                border: 2px solid #e2e8f0; /* gray-300 */
            }
        }
        /* Specific list positions and heights */
        #vegetables-list { top: 50%; left: 45%; max-height: calc(100% - 55px); }
        #fruits-list     { top: 35%; left: 45%; max-height: calc(100% - 40px); }
        #grains-list     { top: 50%; left: 10%; max-height: calc(100% - 55px); }
        #protein-list    { top: 35%; left: 10%; max-height: calc(100% - 40px); }

        /* Individual list items in the plate */
         .plate-section ul li {
            margin-bottom: 5px; /* Spacing between items */
            word-break: break-word; /* Break long words */
            line-height: 1.4; /* Line spacing */
            display: flex; /* Use flexbox for alignment */
            align-items: center; /* Center items vertically */
            padding: 2px 0; /* Vertical padding */
            position: relative; /* For potential future absolute elements */
         }
         /* Remove button styling in the plate */
         .plate-section ul li button {
             padding: 0 5px; /* Padding around the 'x' */
             line-height: 1; /* Ensure button height matches text */
             margin-left: 4px; /* Space between text and button */
             flex-shrink: 0; /* Prevent button from shrinking */
             border: none; /* No border */
             background: none; /* No background */
             cursor: pointer; /* Pointer cursor on hover */
             font-weight: bold;
             font-size: 1.1rem;
             color: #e53e3e; /* red-600 color */
             transition: color 0.2s; /* Smooth color transition on hover */
             text-shadow: 1px 1px 1px rgba(255,255,255,0.5); /* Make 'x' slightly clearer */
         }
          .plate-section ul li button:hover {
             color: #c53030; /* red-700 color on hover */
         }
         /* Text span within list items */
         .plate-section ul li span {
             text-align: left; /* Align text to the left */
         }

        /* Background colors for plate sections */
        #vegetables-section { top: 0; left: 0; background-color: #c6f6d5; border-radius: 100% 0 0 0; } /* green-200, top-left quadrant */
        #fruits-section { bottom: 0; left: 0; background-color: #fed7d7; border-radius: 0 0 0 100%; } /* red-200, bottom-left quadrant */
        #grains-section { top: 0; right: 0; background-color: #fefcbf; border-radius: 0 100% 0 0; } /* yellow-200, top-right quadrant */
        #protein-section { bottom: 0; right: 0; background-color: #fbd38d; border-radius: 0 0 100% 0; } /* orange-300, bottom-right quadrant */

        /* Side sections (Oils and Drinks) styling */
        .side-section {
            text-align: center; /* Center title */
            margin-top: 1rem; /* Space above section */
            padding: 0.75rem; /* Inner spacing */
            border: 1px solid #e2e8f0; /* gray-300 border */
            border-radius: 0.375rem; /* Rounded corners */
            background-color: #ffffff; /* white background */
        }
        .side-section h3 {
            font-weight: bold;
            margin-bottom: 0.5rem; /* Space below title */
            color: #4a5568; /* gray-700 color */
        }
        .side-section ul {
            list-style: none; /* Remove bullets */
            padding: 0;
            margin: 0 auto; /* Center the list block */
            font-size: 0.9rem;
            max-width: 95%; /* Limit list width */
        }
        .side-section ul li {
            margin-bottom: 4px; /* Space between items */
            display: flex; /* Use flexbox */
            align-items: center; /* Align items vertically */
            position: relative;
            padding: 2px 5px; /* Padding around item */
            word-break: break-word; /* Break long words */
        }
        /* Remove button styling in side sections */
        .side-section ul li button {
             padding: 0 5px;
             line-height: 1;
             margin-left: 4px; /* Space between text and button */
             flex-shrink: 0;
             border: none;
             background: none;
             cursor: pointer;
             font-weight: bold;
             font-size: 1rem;
             color: #e53e3e; /* red-600 */
             transition: color 0.2s;
        }
        .side-section ul li button:hover {
            color: #c53030; /* red-700 */
        }
        /* Text span within side section list items */
        .side-section ul li span {
            text-align: left;
        }

        /* Notification styling */
        #notification {
            position: fixed; /* Fixed position */
            bottom: 20px; /* Distance from bottom */
            left: 50%; /* Center horizontally */
            transform: translateX(-50%); /* Precise horizontal centering */
            background-color: #48bb78; /* green-500 background */
            color: white; /* White text */
            padding: 10px 20px; /* Padding */
            border-radius: 5px; /* Rounded corners */
            display: none; /* Hidden by default */
            z-index: 100; /* Ensure it's above other elements */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); /* Subtle shadow */
            transition: opacity 0.5s ease-in-out; /* Fade effect */
            opacity: 0; /* Start hidden for fade */
        }
        #notification.show {
            display: block;
            opacity: 1;
        }
        #notification.error {
            background-color: #f56565; /* red-500 background for errors */
        }

        /* Styles for limited/avoid items */
        .limited-item { font-style: italic; color: #718096; } /* gray-600, italic */
        .avoid-item { font-style: italic; color: #c53030; font-weight: bold;} /* red-700, italic, bold */

        /* Visual enhancements for general buttons */
         button { transition: all 0.2s ease-in-out; } /* Smooth transitions */
         button:hover:not(.plate-section ul li button):not(.side-section ul li button) {
             transform: translateY(-1px);
             box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
         }
         button:active:not(.plate-section ul li button):not(.side-section ul li button) {
              transform: translateY(0);
              box-shadow: none;
         }

        /* Analysis Results Styling */
        #analysis-results h4 {
            font-size: 1rem; /* text-base */
            font-weight: 600; /* font-semibold */
            margin-top: 0.75rem; /* mt-3 */
            margin-bottom: 0.5rem; /* mb-2 */
            color: #4a5568; /* text-gray-700 */
        }
        #analysis-results .nutrition-summary p {
            font-size: 0.875rem; /* text-sm */
            color: #4a5568; /* text-gray-700 */
            margin-bottom: 0.25rem; /* mb-1 */
        }
         #analysis-results .nutrition-summary strong {
             color: #2d3748; /* text-gray-800 */
         }
         #analysis-results .disclaimer {
             font-size: 0.75rem; /* text-xs */
             font-style: italic;
             color: #718096; /* text-gray-600 */
             margin-top: 0.5rem; /* mt-2 */
         }


         /* Responsive adjustments */
         @media (max-width: 600px) {
            .plate-container { width: 90vw; height: 90vw; }
            .plate-section h3 { font-size: 0.9rem; }
            .plate-section ul { font-size: 0.8rem; }
            .plate-section ul li button { font-size: 1rem; }
            .side-section ul { font-size: 0.8rem; }
            .side-section ul li button { font-size: 0.9rem; }
            .add-button { padding-left: 0.75rem; padding-right: 0.75rem; }
            #analysis-results h4 { font-size: 0.9rem; }
            #analysis-results .nutrition-summary p { font-size: 0.8rem; }
         }

    </style>
</head>
<body class="p-4 md:p-8">
    <h1 class="text-2xl md:text-3xl font-bold text-center text-gray-700 mb-6">Mi Plato Interactivo</h1>

    <div class="container mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6 md:gap-8">

        <div class="lg:col-span-1 bg-white p-4 md:p-6 rounded-lg shadow-md order-2 lg:order-1">
            <h2 class="text-xl font-semibold mb-4 text-gray-600">Selecciona Alimentos</h2>

            <div class="mb-4">
                <label for="vegetables-select" class="block text-sm font-medium text-gray-700 mb-1">Vegetales (M√°x: 5):</label>
                <select id="vegetables-select" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">-- Elige un vegetal --</option>
                </select>
                <button onclick="addFood('vegetables')" class="add-button mt-2 w-full text-sm bg-green-500 hover:bg-green-600 text-white py-1 px-3 rounded shadow">A√±adir Vegetal</button>
            </div>
            <div class="mb-4">
                <label for="fruits-select" class="block text-sm font-medium text-gray-700 mb-1">Frutas (M√°x: 3):</label>
                <select id="fruits-select" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">-- Elige una fruta --</option>
                </select>
                <button onclick="addFood('fruits')" class="add-button mt-2 w-full text-sm bg-red-500 hover:bg-red-600 text-white py-1 px-3 rounded shadow">A√±adir Fruta</button>
            </div>
            <div class="mb-4">
                <label for="grains-select" class="block text-sm font-medium text-gray-700 mb-1">Granos Integrales (M√°x: 3):</label>
                <select id="grains-select" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">-- Elige un grano --</option>
                </select>
                <button onclick="addFood('grains')" class="add-button mt-2 w-full text-sm bg-yellow-500 hover:bg-yellow-600 text-white py-1 px-3 rounded shadow">A√±adir Grano</button>
            </div>
            <div class="mb-4">
                <label for="protein-select" class="block text-sm font-medium text-gray-700 mb-1">Prote√≠na Saludable (M√°x: 3):</label>
                <select id="protein-select" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">-- Elige una prote√≠na --</option>
                </select>
                <button onclick="addFood('protein')" class="add-button mt-2 w-full text-sm bg-orange-500 hover:bg-orange-600 text-white py-1 px-3 rounded shadow">A√±adir Prote√≠na</button>
            </div>
             <div class="mb-4">
                <label for="oils-select" class="block text-sm font-medium text-gray-700 mb-1">Aceites Saludables:</label>
                <select id="oils-select" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">-- Elige un aceite --</option>
                </select>
                <button onclick="addFood('oils')" class="add-button mt-2 w-full text-sm bg-teal-500 hover:bg-teal-600 text-white py-1 px-3 rounded shadow">A√±adir Aceite</button>
            </div>
             <div class="mb-4">
                <label for="drinks-select" class="block text-sm font-medium text-gray-700 mb-1">Bebidas:</label>
                <select id="drinks-select" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">-- Elige una bebida --</option>
                </select>
                <button onclick="addFood('drinks')" class="add-button mt-2 w-full text-sm bg-blue-500 hover:bg-blue-600 text-white py-1 px-3 rounded shadow">A√±adir Bebida</button>
            </div>

            <hr class="my-6 border-gray-300">

            <h2 class="text-xl font-semibold mb-4 text-gray-600">An√°lisis y Objetivos</h2>
             <div class="mb-4">
                <label for="goal-select" class="block text-sm font-medium text-gray-700 mb-1">Objetivo:</label>
                <select id="goal-select" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="maintenance">Mantenimiento de peso</option>
                    <option value="loss">P√©rdida de peso</option>
                    <option value="gain">Ganancia de masa muscular</option>
                </select>
            </div>
             <div class="mb-4">
                <label for="calories-input" class="block text-sm font-medium text-gray-700 mb-1">Ingesta Diaria de Calor√≠as (kcal):</label>
                <input type="number" id="calories-input" placeholder="Ej: 2000" min="0" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
            </div>

            <div class="mt-6 space-y-3">
                <button id="analyze-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md shadow">
                    Analizar Plato y Ver Recomendaciones
                </button>
                 <button id="save-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md shadow">
                    Guardar Plato
                </button>
                 <button id="load-button" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-md shadow">
                    Cargar √öltimo Plato Guardado
                </button>
                 <button id="print-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow">
                    Imprimir Plato a PDF
                </button>
                 <button id="clear-button" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md shadow">
                    Limpiar Plato
                </button>
            </div>
        </div>

        <div class="lg:col-span-2 order-1 lg:order-2">
            <div id="printable-area" class="bg-white p-4 md:p-6 rounded-lg shadow-md">
                <div class="plate-container" id="plate">
                    <div id="vegetables-section" class="plate-section">
                        <h3>Vegetales</h3>
                        <ul id="vegetables-list"></ul>
                    </div>
                    <div id="fruits-section" class="plate-section">
                        <h3>Frutas</h3>
                        <ul id="fruits-list"></ul>
                    </div>
                    <div id="grains-section" class="plate-section">
                        <h3>Granos Integrales</h3>
                        <ul id="grains-list"></ul>
                    </div>
                    <div id="protein-section" class="plate-section">
                        <h3>Prote√≠na Saludable</h3>
                        <ul id="protein-list"></ul>
                    </div>
                </div>
                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-6">
                     <div id="oils-side-section" class="side-section bg-teal-100 border border-teal-200">
                         <h3>Aceites Saludables</h3>
                         <ul id="oils-list"></ul>
                     </div>
                     <div id="drinks-side-section" class="side-section bg-blue-100 border border-blue-200">
                         <h3>Bebidas</h3>
                         <ul id="drinks-list"></ul>
                     </div>
                 </div>
                 <div id="analysis-results" class="mt-6 p-4 border border-gray-200 rounded-md bg-gray-50 min-h-[150px]">
                    <h3 class="text-lg font-semibold mb-2 text-gray-700">An√°lisis del Plato y Recomendaciones:</h3>
                    <p class="text-gray-600 italic">Selecciona alimentos y haz clic en "Analizar Plato" para ver los resultados.</p>
                    </div>
            </div>
        </div>
    </div>

    <div id="notification"></div>

    <script>
        // --- NUTRITIONAL DATA (Extracted from PDF, per 100g approx.) ---
        const foodNutritionalData = {
            // Vegetales
            'acelga': { kcal: 20, protein: 1.8, fat: 0.2, carbs: 2.1, fiber: 1.6 },
            'achicoria': { kcal: 17, protein: 1, fat: 0.3, carbs: 3.4, fiber: 1.5 },
            'ajo': { kcal: 149, protein: 6.4, fat: 0.5, carbs: 33, fiber: 2.1 },
            'alcaparras': { kcal: 23, protein: 2.4, fat: 0.9, carbs: 4, fiber: 2.9 },
            'alfalfa (brotes)': { kcal: 23, protein: 4, fat: 0.7, carbs: 1.9, fiber: 1.9 },
            'algas': { kcal: 45, protein: 1.7, fat: 0.5, carbs: 9, fiber: 1.5 }, // Generic value
            'apio': { kcal: 16, protein: 0.7, fat: 0.2, carbs: 3, fiber: 1.6 },
            'apio nabo': { kcal: 42, protein: 1.5, fat: 0.3, carbs: 9, fiber: 1.8 }, // Same as Apionabo
            'apionabo': { kcal: 42, protein: 1.5, fat: 0.3, carbs: 9, fiber: 1.8 },
            'alcachofas': { kcal: 47, protein: 3.3, fat: 0.2, carbs: 10.5, fiber: 5.4 },
            'arvejas': { kcal: 81, protein: 5.4, fat: 0.4, carbs: 14, fiber: 5.5 }, // Similar to Guisantes
            'bamb√∫ (brotes)': { kcal: 27, protein: 2.6, fat: 0.3, carbs: 5.2, fiber: 2.2 },
            'batata': { kcal: 86, protein: 1.6, fat: 0.1, carbs: 20, fiber: 3 }, // Similar to Boniato
            'berenjena': { kcal: 25, protein: 1, fat: 0.2, carbs: 6, fiber: 3 },
            'berro': { kcal: 11, protein: 2.3, fat: 0.1, carbs: 1.3, fiber: 0.5 },
            'boniatos': { kcal: 86, protein: 1.6, fat: 0.1, carbs: 20, fiber: 3 },
            'borraja': { kcal: 20, protein: 1.5, fat: 0.2, carbs: 3, fiber: 2 },
            'br√≥coli': { kcal: 34, protein: 2.8, fat: 0.4, carbs: 7, fiber: 2.6 },
            'calabac√≠n': { kcal: 17, protein: 1.2, fat: 0.3, carbs: 3.1, fiber: 1 },
            'calabaza': { kcal: 26, protein: 1, fat: 0.1, carbs: 6.5, fiber: 0.5 },
            'can√≥nigos': { kcal: 25, protein: 2.5, fat: 0.2, carbs: 3.5, fiber: 1.5 },
            'cardo': { kcal: 17, protein: 1.2, fat: 0.2, carbs: 3.5, fiber: 1.5 },
            'cardo mariano': { kcal: 25, protein: 1, fat: 0.2, carbs: 4, fiber: 2 }, // Note: Often used medicinally
            'casta√±as': { kcal: 131, protein: 1.7, fat: 1.4, carbs: 28, fiber: 5 },
            'cebolla': { kcal: 40, protein: 1.1, fat: 0.1, carbs: 9, fiber: 1.7 },
            'champi√±ones': { kcal: 22, protein: 3.1, fat: 0.3, carbs: 3.3, fiber: 1 },
            'champi√±ones silvestres': { kcal: 22, protein: 3, fat: 0.3, carbs: 3, fiber: 1 }, // Similar to regular
            'chiriv√≠a': { kcal: 75, protein: 1.2, fat: 0.3, carbs: 18, fiber: 4.9 },
            'colinabo': { kcal: 27, protein: 1.7, fat: 0.1, carbs: 6, fiber: 3.6 }, // Kohlrabi
            'col china': { kcal: 12, protein: 1.2, fat: 0.2, carbs: 2.2, fiber: 1 },
            'coles': { kcal: 25, protein: 1.3, fat: 0.1, carbs: 5.8, fiber: 2.5 }, // Repollo
            'coles de bruselas': { kcal: 43, protein: 3.4, fat: 0.3, carbs: 8, fiber: 3.8 },
            'coliflor': { kcal: 25, protein: 1.9, fat: 0.3, carbs: 5, fiber: 2 },
            'c√∫rcuma': { kcal: 354, protein: 7.8, fat: 9.9, carbs: 64, fiber: 21.1 }, // High values, likely dried powder
            'diente de le√≥n': { kcal: 45, protein: 2.7, fat: 0.2, carbs: 7.5, fiber: 3 },
            'edamame': { kcal: 121, protein: 11.9, fat: 5.2, carbs: 8.9, fiber: 5.2 }, // Also in protein
            'endivia': { kcal: 17, protein: 1.2, fat: 0.2, carbs: 3.4, fiber: 3.1 },
            'eneldo': { kcal: 43, protein: 3.5, fat: 1.1, carbs: 7, fiber: 2.1 },
            'escarola': { kcal: 17, protein: 1.2, fat: 0.3, carbs: 3.4, fiber: 1.6 },
            'esp√°rragos': { kcal: 20, protein: 2.2, fat: 0.2, carbs: 3.9, fiber: 2.1 },
            'espinaca': { kcal: 23, protein: 2.9, fat: 0.4, carbs: 3.6, fiber: 2.2 },
            'frijoles': { kcal: 127, protein: 8.7, fat: 0.5, carbs: 22.8, fiber: 6.4 }, // Cooked, generic beans
            'galanga': { kcal: 80, protein: 1.9, fat: 0.5, carbs: 17, fiber: 2 },
            'grelos': { kcal: 28, protein: 2.5, fat: 0.3, carbs: null, fiber: 2.2 }, // Carbs missing in PDF text
            'guisantes': { kcal: 81, protein: 5.4, fat: 0.4, carbs: 14.5, fiber: 5.1 },
            'habas': { kcal: 110, protein: 7.6, fat: 0.7, carbs: 19, fiber: 5.4 }, // Cooked? Assumed
            'hinojo': { kcal: 31, protein: 1.2, fat: 0.2, carbs: 7, fiber: 3.1 },
            'hisopo': { kcal: 101, protein: 3.5, fat: 0.6, carbs: 10, fiber: 1.8 }, // Likely herb/dried
            'hojas de mostaza': { kcal: 27, protein: 2, fat: 0.3, carbs: 3.5, fiber: 1.5 },
            'hongos': { kcal: 22, protein: 3.1, fat: 0.3, carbs: 3.3, fiber: 1 }, // Generic like champi√±ones
            'jengibre': { kcal: 80, protein: 1.8, fat: 0.8, carbs: 17.8, fiber: 2 },
            'j√≠cama': { kcal: 38, protein: 0.7, fat: 0.1, carbs: 8.8, fiber: 4.9 },
            'jud√≠as verdes': { kcal: 31, protein: 1.8, fat: 0.1, carbs: 7, fiber: 3.4 },
            'lechuga': { kcal: 15, protein: 1.4, fat: 0.2, carbs: 2.9, fiber: 1.3 }, // Generic
            'lentejas': { kcal: 116, protein: 9, fat: 0.4, carbs: 20, fiber: 7.9 }, // Cooked, also in protein
            'ma√≠z': { kcal: 86, protein: 3.2, fat: 1.2, carbs: 19, fiber: 2.7 }, // Sweet corn, cooked
            'malanga': { kcal: 119, protein: 1.3, fat: 0.1, carbs: 28, fiber: 4.5 },
            'mandioca': { kcal: 160, protein: 1.4, fat: 0.3, carbs: 38, fiber: 1.8 }, // Yuca
            'mejorana': { kcal: 265, protein: 9, fat: 4.3, carbs: 42, fiber: 69 }, // Approx/dried? High fiber
            'menta': { kcal: 70, protein: 3, fat: 0.2, carbs: 14, fiber: 8 }, // Approx/dried?
            'nabos': { kcal: 28, protein: 1, fat: 0.1, carbs: 6.2, fiber: 1.8 },
            'nabo sueco': { kcal: 37, protein: 1.2, fat: 0.1, carbs: 8.6, fiber: 3 }, // Rutabaga
            '√±ame': { kcal: 118, protein: 1.5, fat: 0.2, carbs: 27, fiber: 4.1 },
            'okra': { kcal: 33, protein: 1.9, fat: 0.2, carbs: 7.5, fiber: 3.2 },
            'or√©gano': { kcal: 40, protein: 2, fat: 0.5, carbs: 6, fiber: 3 }, // Fresh, approx
            'ortiga': { kcal: 42, protein: 2.7, fat: 0.1, carbs: 6.9, fiber: 0.7 },
            'pak choi': { kcal: 13, protein: 1.5, fat: 0.2, carbs: 2.2, fiber: 1 }, // Bok choy
            'palmito': { kcal: 36, protein: 2, fat: 0.4, carbs: 5.2, fiber: 1.8 },
            'pepino': { kcal: 16, protein: 0.7, fat: 0.1, carbs: 3.6, fiber: 0.5 },
            'perifollo': { kcal: 33, protein: 2, fat: 0.3, carbs: 5, fiber: 2 }, // Approx
            'perejil': { kcal: 36, protein: 3, fat: 0.8, carbs: 6.3, fiber: 3.3 },
            'pimientos': { kcal: 31, protein: 1, fat: 0.3, carbs: 6, fiber: 2.1 }, // Red assumed
            'puerro': { kcal: 61, protein: 1.5, fat: 0.3, carbs: 14, fiber: 1.8 },
            'r√°bano': { kcal: 16, protein: 0.7, fat: 0.1, carbs: 3.4, fiber: 1.6 }, // Same as Rabanitos
            'r√°bano daikon': { kcal: 16, protein: 0.7, fat: 0.1, carbs: 3.4, fiber: 1.6 },
            'r√°bano picante': { kcal: 48, protein: 1.2, fat: 0.1, carbs: 11, fiber: 1.6 },
            'rabanitos': { kcal: 16, protein: 0.7, fat: 0.1, carbs: 3.4, fiber: 1.6 },
            'radicchio': { kcal: 23, protein: 1, fat: 0.2, carbs: 4, fiber: 1.5 },
            'remolacha': { kcal: 43, protein: 1.6, fat: 0.2, carbs: 9.6, fiber: 2.8 },
            'remolacha azucarera': { kcal: 43, protein: 1.6, fat: 0.2, carbs: 9.6, fiber: 2.8 }, // Same as Remolacha
            'repollo': { kcal: 25, protein: 1.3, fat: 0.1, carbs: 5.8, fiber: 2.5 }, // Coles
            'romaine': { kcal: 17, protein: 1.2, fat: 0.3, carbs: 3.3, fiber: 2.1 },
            'romero': { kcal: 40, protein: 1.5, fat: 0.3, carbs: 5, fiber: 2 }, // Fresh, approx
            'r√∫cula': { kcal: 25, protein: 2.6, fat: 0.7, carbs: 3.7, fiber: 1.6 },
            'ruibarbo': { kcal: 21, protein: 0.9, fat: 0.2, carbs: 4.5, fiber: 1.8 },
            'salvia': { kcal: 40, protein: 2, fat: 0.3, carbs: 5, fiber: 2 }, // Fresh, approx
            'setas': { kcal: 22, protein: 3.1, fat: 0.3, carbs: 3.3, fiber: 1 }, // Generic, same as Hongos
            'soja': { kcal: 446, protein: 36.5, fat: 19.9, carbs: 30.2, fiber: 9.3 }, // Seed/bean, also protein
            'soja verde': { kcal: 121, protein: 11.9, fat: 5.2, carbs: 8.9, fiber: 5.2 }, // Edamame
            'taro': { kcal: 142, protein: 1.5, fat: 0.1, carbs: 34, fiber: 5 },
            'tomates': { kcal: 18, protein: 0.9, fat: 0.2, carbs: 3.9, fiber: 1.2 },
            'tomillo': { kcal: 40, protein: 2, fat: 0.3, carbs: 5, fiber: 2 }, // Fresh, approx
            'tr√©bol': { kcal: 35, protein: 2, fat: 0.2, carbs: 4, fiber: 1.5 }, // Approx
            'wakame': { kcal: 45, protein: 1, fat: 0.5, carbs: 9, fiber: 1.5 },
            'yuca': { kcal: 160, protein: 1.4, fat: 0.3, carbs: 38, fiber: 1.8 }, // Mandioca
            'zanahoria': { kcal: 41, protein: 0.9, fat: 0.2, carbs: 9.6, fiber: 2.8 },
            'zanahoria blanca': { kcal: 41, protein: 0.9, fat: 0.2, carbs: 9.6, fiber: 2.8 }, // Same as Zanahoria

            // Frutas
            'manzanas': { kcal: 52, protein: 0.3, fat: 0.2, carbs: 13.8, fiber: 2.4 },
            'pl√°tanos': { kcal: 89, protein: 1.1, fat: 0.3, carbs: 22.8, fiber: 2.6 },
            'naranjas': { kcal: 47, protein: 0.9, fat: 0.1, carbs: 11.8, fiber: 2.4 },
            'fresas': { kcal: 32, protein: 0.7, fat: 0.3, carbs: 7.7, fiber: 2 },
            'ar√°ndanos': { kcal: 57, protein: 0.7, fat: 0.3, carbs: 14.5, fiber: 2.4 },
            'uvas': { kcal: 69, protein: 0.7, fat: 0.2, carbs: 18.1, fiber: 0.9 },
            'peras': { kcal: 57, protein: 0.4, fat: 0.1, carbs: 15.2, fiber: 3.1 },
            'melocotones': { kcal: 39, protein: 0.9, fat: 0.3, carbs: 9.5, fiber: 1.5 },
            'kiwi': { kcal: 61, protein: 1.1, fat: 0.5, carbs: 14.7, fiber: 3 },
            'mango': { kcal: 60, protein: 0.8, fat: 0.1, carbs: 15, fiber: 1.6 }, // Corrected fat
            'pi√±a': { kcal: 50, protein: 0.4, fat: 0.5, carbs: 13.1, fiber: 1.4 }, // Corrected protein/fat
            'sand√≠a': { kcal: 30, protein: 0.6, fat: 0.2, carbs: 7.6, fiber: 0.4 },
            'mel√≥n': { kcal: 34, protein: 0.8, fat: 0.2, carbs: 8.2, fiber: 0.9 },
            'frambuesas': { kcal: 52, protein: 1.2, fat: 0.7, carbs: 11.9, fiber: 6.5 },
            'moras': { kcal: 43, protein: 1.4, fat: 0.5, carbs: 9.6, fiber: 5.3 },
            'cerezas': { kcal: 50, protein: 1, fat: 0.3, carbs: 12, fiber: 1.6 }, // Corrected protein/fat
            'mandarinas': { kcal: 53, protein: 0.8, fat: 0.3, carbs: 13.3, fiber: 1.8 },
            'limones': { kcal: 29, protein: 1.1, fat: 0.3, carbs: 9.3, fiber: 2.8 }, // Corrected fat
            // 'aguacate' already listed in vegetables
            'higos': { kcal: 74, protein: 0.8, fat: 0.9, carbs: 19.2, fiber: 2.9 }, // Corrected fat
            'granada': { kcal: 83, protein: 1.7, fat: 1.2, carbs: 19, fiber: 4 },
            'zumos': { kcal: 45, protein: 0.5, fat: 0.1, carbs: 10, fiber: 0.2 }, // Generic approximation for juice

            // Granos Integrales
            'pan de trigo integral': { kcal: 263, protein: 9, fat: 2, carbs: 49, fiber: 6.5 },
            'pasta de trigo integral': { kcal: 350, protein: 12, fat: 2, carbs: 70, fiber: 7 }, // Assumed dry
            'arroz integral': { kcal: 111, protein: 2.6, fat: 0.9, carbs: 23, fiber: 1.8 }, // Cooked
            'avena': { kcal: 389, protein: 16.9, fat: 6.9, carbs: 66.3, fiber: 10.6 }, // Raw flakes
            'quinoa': { kcal: 120, protein: 4.4, fat: 1.9, carbs: 21.3, fiber: 2.8 }, // Cooked
            'cebada': { kcal: 123, protein: 2.3, fat: 0.4, carbs: 28.2, fiber: 3.8 }, // Cooked, integral
            'centeno integral': { kcal: 259, protein: 8, fat: 3.3, carbs: 48, fiber: 5.8 }, // Assumed flour/grain
            'ma√≠z integral (palomitas de ma√≠z)': { kcal: 387, protein: 12.9, fat: 4.5, carbs: 74, fiber: 14.5 }, // Air-popped likely
            'bulgur': { kcal: 342, protein: 12.3, fat: 1.3, carbs: 76, fiber: 18.3 }, // Dry
            'farro': { kcal: 340, protein: 14, fat: 2.5, carbs: 65, fiber: 8 }, // Dry
            'mijo': { kcal: 378, protein: 11, fat: 4.2, carbs: 72.8, fiber: 8.5 }, // Dry
            'tortillas de ma√≠z integral': { kcal: 218, protein: 5.4, fat: 2.5, carbs: 45, fiber: 7 },
            'pan de centeno': { kcal: 259, protein: 8, fat: 3.3, carbs: 48, fiber: 5.8 }, // Same as centeno integral?
            'salvado de avena': { kcal: 246, protein: 16.9, fat: 6.9, carbs: 66.3, fiber: 10.6 }, // Values seem same as Avena? High fiber expected. Let's adjust fiber based on common values ~15g
             // 'salvado de avena': { kcal: 246, protein: 17.3, fat: 7, carbs: 66.2, fiber: 15.4 }, // Adjusted fiber based on external data
            'trigo sarraceno': { kcal: 92, protein: 3.4, fat: 0.6, carbs: 20, fiber: 3 }, // Cooked

            // Prote√≠na Saludable
            'salm√≥n': { kcal: 175, protein: 20, fat: 10, carbs: 0, fiber: 0 },
            'sardinas': { kcal: 208, protein: 25, fat: 11, carbs: 0, fiber: 0 }, // Assumed in oil/sauce
            'caballa': { kcal: 205, protein: 19, fat: 13, carbs: 0, fiber: 0 }, // Verdel
            'at√∫n (fresco)': { kcal: 132, protein: 28, fat: 1, carbs: 0, fiber: 0 },
            'arenque': { kcal: 158, protein: 18, fat: 9, carbs: 0, fiber: 0 },
            'boquer√≥n (anchoa fresca)': { kcal: 160, protein: 18, fat: 9, carbs: 0, fiber: 0 },
            'trucha': { kcal: 148, protein: 20, fat: 7, carbs: 0, fiber: 0 },
            'palometa': { kcal: 150, protein: 20, fat: 7, carbs: 0, fiber: 0 }, // Approx (llampuga)
            'anguila': { kcal: 184, protein: 18, fat: 11, carbs: 0, fiber: 0 },
            'jurel': { kcal: 155, protein: 18, fat: 10, carbs: 0, fiber: 0 }, // Approx (chicharro)
            'emperador (pez espada)': { kcal: 175, protein: 20, fat: 10, carbs: 0, fiber: 0 },
            'bonito del norte': { kcal: 160, protein: 20, fat: 10, carbs: 0, fiber: 0 }, // Values seem high fat? Let's use common data: 130kcal, 28p, 1f
             // 'bonito del norte': { kcal: 130, protein: 28, fat: 1, carbs: 0, fiber: 0 }, // Adjusted
            'merluza': { kcal: 85, protein: 18, fat: 1, carbs: 0, fiber: 0 },
            'bacalao': { kcal: 105, protein: 18, fat: 1, carbs: 0, fiber: 0 }, // Assumed salted/rehydrated? Fresh is lower kcal. Let's use fresh: 82kcal, 18p, 0.7f
             // 'bacalao': { kcal: 82, protein: 18, fat: 0.7, carbs: 0, fiber: 0 }, // Fresh, adjusted
            'lenguado': { kcal: 91, protein: 17, fat: 2, carbs: 0, fiber: 0 },
            'gallo': { kcal: 90, protein: 17, fat: 2, carbs: 0, fiber: 0 }, // Approx
            'lubina': { kcal: 97, protein: 18, fat: 2, carbs: 0, fiber: 0 },
            'dorada': { kcal: 105, protein: 17, fat: 2, carbs: 0, fiber: 0 }, // PDF fat seems low, common data ~7g. Let's use PDF.
            'rape': { kcal: 90, protein: 18, fat: 1, carbs: 0, fiber: 0 },
            'abadejo': { kcal: 87, protein: 17, fat: 0.9, carbs: 0, fiber: 0 },
            'pescadilla': { kcal: 87, protein: 17, fat: 0.9, carbs: 0, fiber: 0 }, // Same as Abadejo
            'pollo (sin piel)': { kcal: 165, protein: 31, fat: 3.6, carbs: 0, fiber: 0 }, // Cooked assumed
            'pavo (sin piel)': { kcal: 135, protein: 29, fat: 1, carbs: 0, fiber: 0 }, // Cooked assumed
            'legumbres': { kcal: 127, protein: 8.7, fat: 0.5, carbs: 22.8, fiber: 6.4 }, // Cooked, generic
            'tofu': { kcal: 76, protein: 8.1, fat: 4.8, carbs: 1.9, fiber: null }, // Fiber varies, assume low ~0.3g
             'tofu': { kcal: 76, protein: 8.1, fat: 4.8, carbs: 1.9, fiber: 0.3 }, // Added fiber estimate
            'tempeh': { kcal: 195, protein: 20.3, fat: 11.4, carbs: 9.4, fiber: null }, // Fiber varies, ~5-8g?
             'tempeh': { kcal: 195, protein: 20.3, fat: 11.4, carbs: 9.4, fiber: 6 }, // Added fiber estimate
            'huevos': { kcal: 143, protein: 12.6, fat: 9.5, carbs: 0.7, fiber: 0 }, // Per 100g (~2 large eggs)
            'nueces': { kcal: 579, protein: 21.2, fat: 49.9, carbs: 21.6, fiber: 12.2 }, // PDF fiber missing, used Almonds avg. PDF value is for almonds
             'almendras': { kcal: 579, protein: 21.2, fat: 49.9, carbs: 21.6, fiber: 12.2 }, // Explicitly almonds
             'anacardos': { kcal: 553, protein: 18.2, fat: 43.9, carbs: 30.2, fiber: 3.3 }, // Added common data
             'pistachos': { kcal: 562, protein: 20.2, fat: 45.3, carbs: 27.5, fiber: 10.6 }, // Added common data
            'semillas (ch√≠a, linaza, calabaza, girasol, etc.)': { kcal: 486, protein: 16.5, fat: 30.7, carbs: 42.1, fiber: 34.4 }, // PDF fiber missing, used Chia avg. High fiber.
             'semillas': { kcal: 486, protein: 16.5, fat: 30.7, carbs: 42.1, fiber: 34.4 }, // Simplified name
            // 'edamame' already listed
            'yogur griego (natural, sin az√∫car a√±adido)': { kcal: 59, protein: 10, fat: 0.4, carbs: 3.6, fiber: 0 },
            'queso cottage (bajo en grasa)': { kcal: 98, protein: 11.1, fat: 4.3, carbs: 3.4, fiber: 0 },
            'carne de res magra': { kcal: 250, protein: 26, fat: 15, carbs: 0, fiber: 0 }, // Cooked assumed
            'cerdo magro': { kcal: 242, protein: 27, fat: 10, carbs: 0, fiber: 0 }, // Cooked assumed
            'garbanzos': { kcal: 139, protein: 7.3, fat: 2.4, carbs: 23.7, fiber: 7.6 }, // Cooked, added common data
            'habichuelas': { kcal: 127, protein: 8.7, fat: 0.5, carbs: 22.8, fiber: 6.4 }, // Same as 'frijoles'/'legumbres'

             // Limited/Avoid items (with nutrition where available/relevant)
            'arroz blanco': { kcal: 130, protein: 2.7, fat: 0.3, carbs: 28, fiber: 0.4 }, // Cooked
            'pan blanco': { kcal: 265, protein: 9, fat: 3.2, carbs: 49, fiber: 2.7 }, // Generic
            'carnes rojas': { kcal: 250, protein: 26, fat: 15, carbs: 0, fiber: 0 }, // Same as 'carne de res magra' for calculation
            'carnes procesadas (tocineta, fiambres, etc.)': { kcal: 400, protein: 15, fat: 35, carbs: 1, fiber: 0 }, // Generic high estimate
            'queso': { kcal: 350, protein: 25, fat: 25, carbs: 2, fiber: 0 }, // Generic medium-fat cheese estimate
            'leche y l√°cteos': { kcal: 60, protein: 3.4, fat: 3.3, carbs: 4.8, fiber: 0 }, // Whole milk estimate
            'mantequilla': { kcal: 717, protein: 0.9, fat: 81, carbs: 0.1, fiber: 0 },
            'margarina': { kcal: 710, protein: 0.2, fat: 80, carbs: 0.7, fiber: 0 }, // Variable, generic estimate

            // Aceites (Fat value is 5g, others 0)
            'aceite de oliva (virgen extra)': { kcal: 44, protein: 0, fat: 5, carbs: 0, fiber: 0 },
            'aceite de aguacate': { kcal: 44, protein: 0, fat: 5, carbs: 0, fiber: 0 },
            'aceite de cacahuete': { kcal: 44, protein: 0, fat: 5, carbs: 0, fiber: 0 },
            'aceite de girasol': { kcal: 44, protein: 0, fat: 5, carbs: 0, fiber: 0 },
            'aceite de soja': { kcal: 44, protein: 0, fat: 5, carbs: 0, fiber: 0 },
            'aceite de ma√≠z': { kcal: 44, protein: 0, fat: 5, carbs: 0, fiber: 0 },
            'aceite de s√©samo': { kcal: 44, protein: 0, fat: 5, carbs: 0, fiber: 0 },
            'aceite de linaza': { kcal: 44, protein: 0, fat: 5, carbs: 0, fiber: 0 },
            'Aguacate': { kcal: 160, protein: 2, fat: 15, carbs: 9, fiber: 7 },

            // Bebidas (Mostly negligible nutrition besides sugar)
            'agua': { kcal: 0, protein: 0, fat: 0, carbs: 0, fiber: 0 },
            'caf√© (sin o con poco az√∫car)': { kcal: 2, protein: 0.1, fat: 0, carbs: 0, fiber: 0 }, // Black
            't√© (sin o con poco az√∫car)': { kcal: 1, protein: 0.1, fat: 0, carbs: 0.2, fiber: 0 }, // Unsweetened
            'bebidas azucaradas': { kcal: 40, protein: 0, fat: 0, carbs: 10, fiber: 0 }, // Cola estimate per 100ml
        };


        // --- APPLICATION CONFIGURATION ---
        const foods = { // Keep original structure for dropdown population and flags
             vegetables: ["Acelga", "Achicoria", "Ajo", "Alcaparras", "Alcachofas", "Alfalfa (Brotes)", "Algas", "Apio", "Apio nabo", /*"Apionabo",*/ "Arrurruz", "Arvejas", "Bamb√∫ (brotes)", "Batata", "Berenjena", "Berro", "Boniatos", "Borraja", "Br√≥coli", "Calabac√≠n", "Calabaza", "Can√≥nigos", "Cardo", "Cardo mariano", "Casta√±as", "Cebolla", "Champi√±ones", "Champi√±ones silvestres", "Chiriv√≠a", "Col china", "Coles", "Coles de Bruselas", "Coliflor", "Colinabo", "C√∫rcuma", "Diente de le√≥n", "Edamame", "Endivia", "Eneldo", "Escarola", "Esp√°rragos", "Espinaca", /*"Faneca",*/ "Frijoles", "Galanga", "Grelos", "Guisantes", "Habas", "Hinojo", "Hisopo", "Hojas de mostaza", "Hongos", /*"Hortalizas de hoja verde", "Hortalizas de ra√≠z", "Hortalizas de tallo",*/ "Jengibre", "J√≠cama", "Jud√≠as verdes", /*"Kion", "Kohlrabi", "Lavanda",*/ "Lechuga", "Lentejas", "Ma√≠z", "Malanga", "Mandioca", "Mejorana", "Menta", "Nabos", "Nabo sueco", "√ëame", "Okra", "Or√©gano", "Ortiga", /*"Otoe",*/ "Pak choi", "Palmito", "Pepino", "Perejil", "Perifollo", "Pimientos", "Puerro", "Rabanitos", "R√°bano", "R√°bano daikon", "R√°bano picante", "Radicchio", "Remolacha", "Remolacha azucarera", "Repollo", "Romaine", "Romero", "R√∫cula", "Ruibarbo", /*"Salicornia",*/ "Salvia", /*"Samphire",*/ "Setas", "Soja", "Soja verde", "Taro", "Tomates", "Tomillo", /*"Topinambur",*/ "Tr√©bol", /*"Verdolaga",*/ "Wakame", "Yaut√≠a", "Yuca", "Zanahoria", "Zanahoria blanca", /*"Zapallo"*/], // Removed duplicates/generic terms if specific exists
            fruits: ["Ar√°ndanos", "Cerezas", "Frambuesas", "Fresas", "Granada", "Higos", "Kiwi", "Limones", "Mandarinas", "Mango", "Manzanas", "Melocotones", "Mel√≥n", "Moras", "Naranjas", "Peras", "Pi√±a", "Pl√°tanos", "Sand√≠a", "Uvas", { name: "Zumos", limited: true }],
            grains: ["Arroz integral", "Avena", "Bulgur", "Cebada", "Centeno integral", "Farro", "Ma√≠z integral (palomitas de ma√≠z)", "Mijo", "Pan de centeno", "Pan de trigo integral", "Pasta de trigo integral", "Quinoa", "Salvado de avena", "Tortillas de ma√≠z integral", "Trigo sarraceno", { name: "Arroz blanco", limited: true }, { name: "Pan blanco", limited: true }],
            protein: ["Abadejo", "Almendras", "Anacardos", "Anguila", "Arenque", "At√∫n (fresco)", "Bacalao", "Bonito del norte", "Boquer√≥n (anchoa fresca)", "Caballa", /*"Carne de res magra",*/ { name: "Carnes rojas", limited: true }, { name: "Carnes procesadas (tocineta, fiambres, etc.)", limited: true, avoid: true }, "Cerdo magro", { name: "Queso", limited: true }, { name: "Queso cottage (bajo en grasa)", limited: false }, "Edamame", "Emperador (pez espada)", "Gallo", "Garbanzos", "Guisantes", "Habichuelas", "Huevos", "Jurel", "Legumbres", "Lenguado", "Lentejas", { name: "Leche y l√°cteos", limited: true }, "Lubina", "Merluza", "Nueces", "Palometa", "Pescadilla", "Pistachos", "Pollo (sin piel)", "Rape", "Salm√≥n", "Sardinas", "Semillas", "Tempeh", "Tofu", "Trucha", "Pavo (sin piel)", "Yogur griego (natural, sin az√∫car a√±adido)"], // Simplified names
            oils: ["Aguacate","Aceite de aguacate", "Aceite de cacahuete", "Aceite de girasol", "Aceite de linaza", "Aceite de ma√≠z", "Aceite de oliva (virgen extra)", "Aceite de s√©samo", "Aceite de soja", { name: "Mantequilla", limited: true }, { name: "Margarina", limited: true, avoid: true }],
            drinks: ["Agua", "Caf√© (sin o con poco az√∫car)", "T√© (sin o con poco az√∫car)", { name: "Bebidas azucaradas", limited: true, avoid: true }]
        };

        const categoryLimits = {
            vegetables: 5, fruits: 3, grains: 3, protein: 3
        };

        // --- APPLICATION STATE ---
        // Now stores objects: { name: string, category: string, nutrition: object | null }
        let currentPlate = {
            vegetables: [], fruits: [], grains: [], protein: [], oils: [], drinks: []
        };
        let notificationTimeout = null;

        // --- DOM ELEMENTS CACHE ---
        const selectors = { // Select dropdowns
            vegetables: document.getElementById('vegetables-select'),
            fruits: document.getElementById('fruits-select'),
            grains: document.getElementById('grains-select'),
            protein: document.getElementById('protein-select'),
            oils: document.getElementById('oils-select'),
            drinks: document.getElementById('drinks-select')
        };
        const lists = { // UL elements for displaying selected items
            vegetables: document.getElementById('vegetables-list'),
            fruits: document.getElementById('fruits-list'),
            grains: document.getElementById('grains-list'),
            protein: document.getElementById('protein-list'),
            oils: document.getElementById('oils-list'),
            drinks: document.getElementById('drinks-list')
        };
        const analysisResultsDiv = document.getElementById('analysis-results');
        const goalSelect = document.getElementById('goal-select');
        const caloriesInput = document.getElementById('calories-input');
        const notificationDiv = document.getElementById('notification');
        const printableArea = document.getElementById('printable-area');
        const analyzeBtn = document.getElementById('analyze-button');
        const saveBtn = document.getElementById('save-button');
        const loadBtn = document.getElementById('load-button');
        const printBtn = document.getElementById('print-button');
        const clearBtn = document.getElementById('clear-button');

        // --- HELPER FUNCTIONS ---

        function showNotification(message, duration = 3000, isError = false) {
            if (notificationTimeout) clearTimeout(notificationTimeout);
            notificationDiv.textContent = message;
            notificationDiv.className = 'notification';
            if (isError) notificationDiv.classList.add('error');
            notificationDiv.classList.add('show');
            notificationTimeout = setTimeout(() => {
                notificationDiv.classList.remove('show');
                notificationTimeout = null;
            }, duration);
        }

        /** Gets nutritional data for a food item name. Handles lowercase conversion. */
        function getNutritionData(foodName) {
            if (!foodName) return null;
            const lowerCaseName = foodName.toLowerCase();
            // Specific mapping for names that might differ slightly
            const nameMap = {
                'coles': 'repollo',
                'colinabo': 'kohlrabi', // Assuming kohlrabi data is more accurate if available
                'ma√≠z': 'ma√≠z (dulce, cocido)', // Be specific if needed
                'mandioca': 'yuca',
                'soja verde': 'edamame',
                'carnes rojas': 'carne de res magra', // Use beef as proxy
                'legumbres': 'frijoles', // Use generic beans
                'semillas': 'semillas (ch√≠a, linaza, calabaza, girasol, etc.)', // Use generic seeds
                'nueces': 'almendras' // Default to almonds if just 'Nueces' is selected
                // Add more mappings if needed
            };
            const lookupName = nameMap[lowerCaseName] || lowerCaseName;
            return foodNutritionalData[lookupName] || null;
        }


        function populateSelectors() {
            for (const category in foods) {
                const selectElement = selectors[category];
                if (!selectElement) continue;

                const sortedFoods = [...foods[category]].sort((a, b) => {
                    const nameA = typeof a === 'string' ? a : a.name;
                    const nameB = typeof b === 'string' ? b : b.name;
                    return nameA.localeCompare(nameB, 'es', { sensitivity: 'base' });
                });

                sortedFoods.forEach(food => {
                    const option = document.createElement('option');
                    let displayName = '';
                    let valueName = '';
                    let isLimited = false;
                    let isAvoid = false;

                    if (typeof food === 'string') {
                        valueName = food;
                        displayName = food;
                    } else {
                        valueName = food.name;
                        displayName = food.name;
                        isLimited = food.limited || false;
                        isAvoid = food.avoid || false;
                        if (isAvoid) displayName += ' (evitar)';
                        else if (isLimited) displayName += ' (limitar)';
                        option.dataset.limited = isLimited;
                        option.dataset.avoid = isAvoid;
                        if (isAvoid) option.classList.add('text-red-600', 'font-semibold');
                        else if (isLimited) option.classList.add('text-yellow-600');
                    }
                    option.value = valueName;
                    option.textContent = displayName;
                    selectElement.appendChild(option);
                });
            }
        }

        // --- CORE PLATE FUNCTIONS ---

        function addFood(category) {
            const selectElement = selectors[category];
            const listElement = lists[category];
            const selectedValue = selectElement.value;

            if (!selectedValue) {
                 showNotification('Por favor, selecciona un alimento.', 2000, true);
                 return;
            }
             if (!listElement) {
                 console.error(`List element not found for category: ${category}`);
                 return;
             }

            const limit = categoryLimits[category];
            if (limit !== undefined && currentPlate[category].length >= limit) {
                 const categoryName = category === 'vegetables' ? 'vegetales' : category === 'fruits' ? 'frutas' : category === 'grains' ? 'granos' : 'prote√≠nas';
                 showNotification(`M√°ximo de ${limit} ${categoryName} alcanzado.`, 3000, true);
                 selectElement.value = "";
                 return;
            }

            // Check for duplicates using the 'name' property of the objects
            if (currentPlate[category].some(item => item.name === selectedValue)) {
                 const categoryNameFriendly = category === 'vegetables' ? 'vegetales' : category === 'fruits' ? 'frutas' : category === 'grains' ? 'granos integrales' : category === 'protein' ? 'prote√≠na saludable' : category === 'oils' ? 'aceites saludables' : 'bebidas';
                 showNotification(`${selectedValue} ya est√° en la secci√≥n de ${categoryNameFriendly}.`, 2500, true);
                 selectElement.value = "";
                 return;
            }

            // Get nutrition data for the selected food
            const nutrition = getNutritionData(selectedValue);
            if (!nutrition && category !== 'drinks' && category !== 'oils') { // Allow adding oils/drinks even without full data initially
                console.warn(`Nutritional data not found for: ${selectedValue}`);
            }

            // Add food object to the state array
            currentPlate[category].push({
                name: selectedValue,
                category: category,
                nutrition: nutrition // Store the fetched nutrition data (or null)
            });

            renderPlate();
            selectElement.value = "";
        }

        function removeFood(category, foodName) {
            // Filter out the item to remove based on its name
            currentPlate[category] = currentPlate[category].filter(item => item.name !== foodName);
            renderPlate();
        }

        function renderPlate() {
            for (const category in lists) {
                const listElement = lists[category];
                if (!listElement) continue;

                listElement.innerHTML = '';

                // Iterate over the array of food objects for the category
                currentPlate[category].forEach(foodItem => {
                    const foodName = foodItem.name; // Get the name from the object
                    const li = document.createElement('li');
                    const textSpan = document.createElement('span');
                    textSpan.textContent = foodName;

                    // Find the original food config to check for limited/avoid flags
                    const foodConfig = foods[category].find(f => (typeof f === 'string' ? f : f.name) === foodName);
                    if (typeof foodConfig === 'object') {
                         if(foodConfig.avoid) textSpan.classList.add('avoid-item');
                         else if (foodConfig.limited) textSpan.classList.add('limited-item');
                    }

                    li.appendChild(textSpan);

                    const removeBtn = document.createElement('button');
                    removeBtn.innerHTML = '&times;';
                    removeBtn.setAttribute('aria-label', `Eliminar ${foodName}`);
                    // Pass the name to removeFood
                    removeBtn.onclick = () => removeFood(category, foodName);
                    li.appendChild(removeBtn);

                    listElement.appendChild(li);
                });
            }
        }

        // --- ANALYSIS FUNCTION ---

        /** Calculates total nutrition for the current plate */
        function calculateTotalNutrition(plate) {
            const totals = { kcal: 0, protein: 0, fat: 0, carbs: 0, fiber: 0, itemsWithData: 0, totalItems: 0 };
            for (const category in plate) {
                plate[category].forEach(item => {
                    totals.totalItems++;
                    if (item.nutrition) {
                        totals.itemsWithData++;
                        totals.kcal += item.nutrition.kcal || 0;
                        totals.protein += item.nutrition.protein || 0;
                        totals.fat += item.nutrition.fat || 0;
                        totals.carbs += item.nutrition.carbs || 0;
                        // Ensure fiber is treated as a number, defaulting to 0 if null/undefined
                        totals.fiber += Number(item.nutrition.fiber) || 0;
                    }
                });
            }
            // Round totals for display
            totals.kcal = Math.round(totals.kcal);
            totals.protein = Math.round(totals.protein * 10) / 10;
            totals.fat = Math.round(totals.fat * 10) / 10;
            totals.carbs = Math.round(totals.carbs * 10) / 10;
            totals.fiber = Math.round(totals.fiber * 10) / 10;
            return totals;
        }


        function analyzePlate() {
            const goal = goalSelect.value;
            const caloriesStr = caloriesInput.value.trim();
            const targetCalories = caloriesStr !== '' && !isNaN(caloriesStr) && Number(caloriesStr) >= 0 ? parseInt(caloriesStr) : null;

            let results = { score: 100, errors: [], warnings: [], suggestions: [], proportions: {} };
            const plateCategories = ['vegetables', 'fruits', 'grains', 'protein'];
            const totalPlateItems = plateCategories.reduce((sum, cat) => sum + currentPlate[cat].length, 0);

             // --- 0. Calculate Total Nutrition ---
            const nutritionalTotals = calculateTotalNutrition(currentPlate);
            const plateKcal = nutritionalTotals.kcal;

            // --- 1. Handle Empty Plate ---
            if (totalPlateItems === 0 && currentPlate.oils.length === 0 && currentPlate.drinks.length === 0) { // Check all sections
                analysisResultsDiv.innerHTML = `
                    <h3 class="text-lg font-semibold mb-2 text-gray-700">An√°lisis del Plato y Recomendaciones:</h3>
                    <p class="text-gray-600 italic">A√±ade alimentos al plato para poder analizarlo.</p>`;
                return;
            }

            // --- 2. Calculate Proportions (Only for main plate items) ---
            if (totalPlateItems > 0) {
                const vegCount = currentPlate.vegetables.length;
                const fruitCount = currentPlate.fruits.length;
                const grainCount = currentPlate.grains.length;
                const proteinCount = currentPlate.protein.length;
                const vegFruitRatio = (vegCount + fruitCount) / totalPlateItems;
                const grainRatio = grainCount / totalPlateItems;
                const proteinRatio = proteinCount / totalPlateItems;
                results.proportions = {
                    vegFruit: Math.round(vegFruitRatio * 100),
                    grains: Math.round(grainRatio * 100),
                    protein: Math.round(proteinRatio * 100)
                };

                // --- 3. Evaluate Proportions ---
                if (vegFruitRatio < 0.4) { results.warnings.push(`Proporci√≥n baja de vegetales y frutas (${results.proportions.vegFruit}%). Intenta que ocupen ~mitad del plato.`); results.score -= 15; }
                else if (vegFruitRatio > 0.6) { results.suggestions.push(`¬°Buena proporci√≥n de vegetales y frutas (${results.proportions.vegFruit}%)!`); }
                else { results.suggestions.push(`Proporci√≥n adecuada de vegetales y frutas (${results.proportions.vegFruit}%).`); }
                if (vegCount === 0 && fruitCount === 0) { results.errors.push("A√±ade vegetales y/o frutas."); results.score -= 20; }
                else if (vegCount === 0) { results.warnings.push("Faltan vegetales."); results.score -= 10; }

                if (grainRatio < 0.2) { results.warnings.push(`Proporci√≥n baja de granos (${results.proportions.grains}%). Objetivo: ~25%.`); results.score -= 10; }
                else if (grainRatio > 0.35) { results.warnings.push(`Proporci√≥n alta de granos (${results.proportions.grains}%). Prioriza integrales.`); results.score -= 5; }
                else { results.suggestions.push(`Proporci√≥n adecuada de granos (${results.proportions.grains}%).`); }
                if (grainCount === 0) { results.warnings.push("Incluye granos, preferiblemente integrales."); results.score -= 5; }

                if (proteinRatio < 0.2) { results.warnings.push(`Proporci√≥n baja de prote√≠na (${results.proportions.protein}%). Objetivo: ~25%.`); results.score -= 10; }
                else if (proteinRatio > 0.35) { results.warnings.push(`Proporci√≥n alta de prote√≠na (${results.proportions.protein}%). Elige fuentes magras.`); results.score -= 5; }
                else { results.suggestions.push(`Proporci√≥n adecuada de prote√≠na (${results.proportions.protein}%).`); }
                if (proteinCount === 0) { results.warnings.push("A√±ade una fuente de prote√≠na saludable."); results.score -= 5; }
            } else {
                 results.proportions = { vegFruit: 0, grains: 0, protein: 0 }; // Set proportions to 0 if no main items
                 results.warnings.push("El plato principal (vegetales, frutas, granos, prote√≠na) est√° vac√≠o.");
                 results.score -= 20;
            }


            // --- 4. Evaluate Types of Foods (Limited/Avoid) - Across ALL categories ---
            let limitedItemsFound = [], avoidItemsFound = [], refinedGrainsFound = [], redMeatFound = false, processedMeatFound = false;
            for (const category in currentPlate) {
                currentPlate[category].forEach(item => {
                    const foodName = item.name;
                    // Find the config in the original 'foods' object for flags
                    const foodConfig = foods[category]?.find(f => (typeof f === 'string' ? f : f.name) === foodName);
                    if (typeof foodConfig === 'object') { // Check if it's an object with flags
                        if(foodConfig.avoid) {
                            avoidItemsFound.push(foodName);
                            if (foodName.toLowerCase().includes("procesadas")) processedMeatFound = true;
                        } else if (foodConfig.limited) {
                            limitedItemsFound.push(foodName);
                            if ((foodName.toLowerCase().includes("arroz blanco") || foodName.toLowerCase().includes("pan blanco")) && category === 'grains') refinedGrainsFound.push(foodName);
                            if (foodName.toLowerCase().includes("carnes rojas") && category === 'protein') redMeatFound = true;
                        }
                    }
                });
            }
            if (avoidItemsFound.length > 0) { results.errors.push(`Evita: ${avoidItemsFound.join(', ')}.`); results.score -= avoidItemsFound.length * 15; }
            if (processedMeatFound) { results.errors.push("Evita carnes procesadas por salud."); }
            if (limitedItemsFound.length > 0) { results.warnings.push(`Modera: ${limitedItemsFound.join(', ')}.`); results.score -= limitedItemsFound.length * 5; }
            if (refinedGrainsFound.length > 0 && currentPlate.grains.length > 0) { // Check grainCount specifically
                const propRefined = refinedGrainsFound.length / currentPlate.grains.length;
                if (propRefined > 0.5) { results.warnings.push(`Prioriza granos integrales sobre refinados (${refinedGrainsFound.join(', ')}).`); results.score -= 10; }
                else { results.suggestions.push(`Has incluido granos refinados (${refinedGrainsFound.join(', ')}). Prefiere integrales.`); }
            }
            if (redMeatFound) { results.warnings.push("Limita carnes rojas a pocas veces por semana/mes."); results.score -= 5; }

            // --- 5. Evaluate Oils and Drinks ---
             if (currentPlate.oils.length === 0) { results.warnings.push("A√±ade aceites saludables (ej: oliva virgen extra)."); results.score -= 5; }
             else { let healthyOils = currentPlate.oils.filter(item => !foods.oils.find(f => typeof f === 'object' && f.name === item.name && (f.limited || f.avoid))); if (healthyOils.length === 0) { results.warnings.push("Prioriza aceites vegetales sobre los de consumo limitado."); results.score -= 5; } else { results.suggestions.push("¬°Bien por incluir aceites saludables!"); } if (currentPlate.oils.some(item => item.name === "Margarina")) { results.warnings.push("Evita la margarina (grasas trans)."); results.score -= 5; } if (currentPlate.oils.some(item => item.name === "Mantequilla")) { results.suggestions.push("Consume mantequilla con moderaci√≥n."); } }

             if (currentPlate.drinks.length === 0) { results.warnings.push("Selecciona una bebida. El agua es la mejor opci√≥n."); results.score -= 5; }
             else if (!currentPlate.drinks.some(item => item.name === "Agua")) { results.warnings.push("Recuerda que el agua es la mejor bebida."); results.score -= 5; }
             else { results.suggestions.push("¬°Bien por incluir agua!"); }
             if (currentPlate.drinks.some(item => item.name === "Bebidas azucaradas")) { results.errors.push("Evita las bebidas azucaradas."); results.score -= 15; }
             if (currentPlate.drinks.some(item => item.name.includes("Caf√©") || item.name.includes("T√©"))) { results.suggestions.push("Caf√©/T√© (sin az√∫car) con moderaci√≥n."); }
             // Check for "Zumos" added via the fruits category (where it's marked limited)
             if (currentPlate.fruits.some(item => item.name === "Zumos")) { results.warnings.push("Es mejor tomar la fruta entera que en zumo."); results.score -= 5; }


            // --- 6. Generate Nutritional Feedback based on Goal/Calories ---
            if (targetCalories !== null) {
                let nutritionMsg = `Para tu objetivo de ${targetCalories} kcal diarias (${goal === 'loss' ? 'p√©rdida' : goal === 'gain' ? 'ganancia' : 'mantenimiento'}):`;
                const estimatedMealKcal = plateKcal;
                const idealMealKcal = targetCalories / 3; // Simple assumption: 3 meals a day

                nutritionMsg += ` Este plato aporta aprox. ${estimatedMealKcal} kcal.`;

                if (estimatedMealKcal > idealMealKcal * 1.25) {
                    nutritionMsg += ` Es bastante alto para una sola comida. Considera reducir porciones o alimentos m√°s cal√≥ricos`;
                    if (goal === 'loss') nutritionMsg += `, especialmente si buscas perder peso.`;
                    else if (goal === 'maintenance') nutritionMsg += `.`;
                    else nutritionMsg += `, aunque para ganar peso puede ser adecuado si el resto del d√≠a compensas.`;
                    results.warnings.push(nutritionMsg);
                    results.score -= 5;
                } else if (estimatedMealKcal < idealMealKcal * 0.75 && estimatedMealKcal > 0) { // Avoid warning if plate is nearly empty
                    nutritionMsg += ` Es relativamente bajo para una comida principal. Aseg√∫rate de compensar en otras comidas`;
                     if (goal === 'gain') nutritionMsg += `, especialmente si buscas ganar peso. Podr√≠as a√±adir m√°s cantidad o alimentos densos.`;
                     else if (goal === 'maintenance') nutritionMsg += `.`;
                     else nutritionMsg += `, aunque para perder peso puede ser adecuado si te sientes saciado.`;
                    results.warnings.push(nutritionMsg);
                    results.score -= 5;
                } else if (estimatedMealKcal > 0) { // Only suggest if plate has calories
                    nutritionMsg += ` Est√° dentro de un rango razonable para una comida principal.`;
                    results.suggestions.push(nutritionMsg);
                }

                // Macronutrient comments based on goal (only if plate has content)
                if (estimatedMealKcal > 0) {
                    const totalProtein = nutritionalTotals.protein;
                    const totalFat = nutritionalTotals.fat;
                    const totalCarbs = nutritionalTotals.carbs;

                    if (goal === 'gain') {
                        if (totalProtein < 25) {
                            results.warnings.push("Para ganar m√∫sculo, intenta incluir m√°s prote√≠na en esta comida (ej: pollo, pescado, legumbres, tofu)."); results.score -= 5;
                        } else { results.suggestions.push("Buen aporte de prote√≠nas para la recuperaci√≥n muscular."); }
                        if (totalCarbs < 40) { results.suggestions.push("Aseg√∫rate de incluir suficientes carbohidratos complejos (granos integrales, batata) para energ√≠a."); }
                    } else if (goal === 'loss') {
                        if (totalFat > 25) {
                            results.warnings.push("Si buscas perder peso, modera las fuentes de grasa en esta comida, aunque prioriza las saludables (aguacate, aceite de oliva, nueces)."); results.score -= 5;
                        }
                        if (nutritionalTotals.fiber < 8) {
                             results.warnings.push("Aumentar la fibra (m√°s vegetales, legumbres, granos integrales) puede ayudarte a sentirte m√°s lleno."); results.score -= 5;
                        } else { results.suggestions.push(`Buen aporte de fibra (${nutritionalTotals.fiber}g), ayuda a la saciedad.`); }
                    } else { // Maintenance
                        results.suggestions.push(`Macronutrientes (Prote√≠na: ${totalProtein}g, Grasa: ${totalFat}g, Carbs: ${totalCarbs}g) parecen razonables para mantenimiento. Ajusta seg√∫n tu actividad.`);
                    }
                }

            } else if (caloriesStr !== '') {
                 results.warnings.push("Introduce un n√∫mero v√°lido de calor√≠as diarias.");
            } else {
                results.warnings.push("Introduce calor√≠as y objetivo para consejos nutricionales m√°s detallados.");
            }


            // --- 7. Finalize Score and Display Results ---
            results.score = Math.max(0, Math.min(100, Math.round(results.score)));

            // Build HTML for results display
            let htmlResult = `<h3 class="text-lg font-semibold mb-3 text-gray-700">An√°lisis Detallado (Puntuaci√≥n: ${results.score}/100)</h3>`;

            // Display Proportions only if main plate has items
            if (totalPlateItems > 0) {
                htmlResult += `<p class="text-sm mb-3 text-gray-600">Proporciones Aprox. (Plato Principal):
                                <span class="font-medium text-green-700">Veg/Fruta ${results.proportions.vegFruit}%</span>,
                                <span class="font-medium text-yellow-700">Granos ${results.proportions.grains}%</span>,
                                <span class="font-medium text-orange-700">Prote√≠na ${results.proportions.protein}%</span>
                              </p>`;
            }

            // Display Nutritional Summary (always display structure, even if values are 0)
            htmlResult += `<div class="nutrition-summary mt-4 mb-3 p-3 bg-blue-50 border border-blue-200 rounded-md shadow-sm">
                            <h4 class="text-base font-semibold mb-2 text-blue-800">Resumen Nutricional Estimado del Plato:</h4>
                            <p><strong>Calor√≠as:</strong> ${nutritionalTotals.kcal} kcal</p>
                            <p><strong>Prote√≠nas:</strong> ${nutritionalTotals.protein} g</p>
                            <p><strong>Grasas:</strong> ${nutritionalTotals.fat} g</p>
                            <p><strong>Carbohidratos:</strong> ${nutritionalTotals.carbs} g</p>
                            <p><strong>Fibra:</strong> ${nutritionalTotals.fiber} g</p>
                            <p class="disclaimer">(*) Estimaci√≥n basada en 100g por alimento a√±adido. Las porciones reales pueden variar. ${nutritionalTotals.itemsWithData < nutritionalTotals.totalItems ? `(${nutritionalTotals.itemsWithData} de ${nutritionalTotals.totalItems} items con datos nutricionales)` : ''}</p>
                          </div>`;

            // Display Errors, Warnings, Suggestions
            if (results.errors.length > 0) {
                htmlResult += `<div class="mb-3 p-3 bg-red-100 border-l-4 border-red-500 text-red-800 rounded-r-md shadow-sm"><strong><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1 -mt-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>¬°Puntos Cr√≠ticos!</strong><ul class="list-disc list-inside mt-1 text-sm space-y-1">${results.errors.map(e => `<li>${e}</li>`).join('')}</ul></div>`;
            }
            if (results.warnings.length > 0) {
                htmlResult += `<div class="mb-3 p-3 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 rounded-r-md shadow-sm"><strong><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1 -mt-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.636-1.176 2.85-1.176 3.486 0l5.58 10.283c.636 1.176-.477 2.618-1.743 2.618H4.42c-1.266 0-2.379-1.442-1.743-2.618l5.58-10.283zM9 13a1 1 0 112 0 1 1 0 01-2 0zm1-6a1 1 0 00-1 1v3a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>Sugerencias Importantes:</strong><ul class="list-disc list-inside mt-1 text-sm space-y-1">${results.warnings.map(w => `<li>${w}</li>`).join('')}</ul></div>`;
            }
            if (results.suggestions.length > 0) {
                htmlResult += `<div class="p-3 bg-green-100 border-l-4 border-green-500 text-green-800 rounded-r-md shadow-sm"><strong><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1 -mt-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>Consejos y Puntos Positivos:</strong><ul class="list-disc list-inside mt-1 text-sm space-y-1">${results.suggestions.map(s => `<li>${s}</li>`).join('')}</ul></div>`;
            }

            analysisResultsDiv.innerHTML = htmlResult;
        }


        // --- SAVE, LOAD, CLEAR, PRINT FUNCTIONS ---

        function savePlate() {
            console.log("[Save Plate] Intentando guardar:", currentPlate); // DEBUG
            try {
                // Save the enhanced currentPlate structure
                localStorage.setItem('interactivePlateData', JSON.stringify(currentPlate));
                console.log("[Save Plate] Datos guardados exitosamente en localStorage."); // DEBUG
                showNotification('Plato guardado correctamente.');
            } catch (e) {
                console.error("[Save Plate] Error saving plate data to localStorage:", e); // DEBUG
                // Provide more specific error message
                let errorMsg = 'Error desconocido al guardar el plato.';
                if (e.name === 'QuotaExceededError') {
                    errorMsg = 'Error al guardar: Almacenamiento local lleno.';
                } else if (e.name === 'SecurityError') {
                    errorMsg = 'Error al guardar: Almacenamiento local desactivado o no permitido por el navegador.';
                }
                showNotification(errorMsg, 4000, true);
            }
        }

        function loadPlate() {
            console.log("[Load Plate] Intentando cargar datos..."); // DEBUG
            let loadedSuccessfully = false;
            let plateIsEmpty = true;
            let savedData = null; // Keep track of raw saved data for debugging
            try {
                savedData = localStorage.getItem('interactivePlateData');
                if (savedData) {
                    console.log("[Load Plate] Datos encontrados en localStorage:", savedData); // DEBUG
                    const parsedData = JSON.parse(savedData);
                    console.log("[Load Plate] Datos parseados:", parsedData); // DEBUG

                    // Reset currentPlate and merge saved data, ensuring all keys and structure exist
                    const defaultPlate = { vegetables: [], fruits: [], grains: [], protein: [], oils: [], drinks: [] };
                    currentPlate = { ...defaultPlate }; // Start with default structure

                    let migrationNeeded = false; // Flag if old format detected

                    for (const category in defaultPlate) {
                        if (parsedData[category] && Array.isArray(parsedData[category])) {
                            // Ensure each item has the correct structure (name, category, nutrition)
                            currentPlate[category] = parsedData[category]
                                .map(item => {
                                    // Compatibility check: if old format (string), convert it
                                    if (typeof item === 'string') {
                                        migrationNeeded = true; // Mark that migration happened
                                        console.log(`[Load Plate] Migrando item antiguo: ${item} en categor√≠a ${category}`); // DEBUG
                                        return {
                                            name: item,
                                            category: category,
                                            nutrition: getNutritionData(item)
                                        };
                                    }
                                    // If it's an object, ensure it has the needed keys
                                    if (typeof item === 'object' && item !== null && item.name) {
                                        // Ensure nutrition data is present or re-fetched if missing
                                        const nutritionData = item.nutrition || getNutritionData(item.name);
                                        return {
                                            name: item.name,
                                            category: item.category || category, // Use saved category or current loop category
                                            nutrition: nutritionData
                                        };
                                    }
                                    console.warn("[Load Plate] Item inv√°lido encontrado y filtrado:", item); // DEBUG
                                    return null; // Invalid item format
                                })
                                .filter(item => item !== null); // Remove invalid items
                        }
                    }
                     // Check if any items were actually loaded
                    plateIsEmpty = Object.values(currentPlate).every(arr => arr.length === 0);
                    loadedSuccessfully = !plateIsEmpty; // Consider successful only if data was loaded

                    if (migrationNeeded) {
                        console.log("[Load Plate] Se realiz√≥ una migraci√≥n de datos del formato antiguo."); // DEBUG
                        showNotification("Datos antiguos actualizados al nuevo formato.", 2500);
                        // Optionally re-save immediately after migration
                        // savePlate();
                    }

                } else {
                     console.log("[Load Plate] No se encontraron datos guardados en localStorage."); // DEBUG
                     currentPlate = { vegetables: [], fruits: [], grains: [], protein: [], oils: [], drinks: [] };
                     plateIsEmpty = true;
                }
            } catch (e) {
                console.error("[Load Plate] Error loading or parsing plate data from localStorage:", e); // DEBUG
                console.error("[Load Plate] Datos crudos que causaron el error:", savedData); // Log raw data on error
                showNotification('Error al cargar/procesar el plato guardado. Se mostrar√° un plato vac√≠o.', 4000, true);
                currentPlate = { vegetables: [], fruits: [], grains: [], protein: [], oils: [], drinks: [] };
                plateIsEmpty = true;
            }

            renderPlate(); // Render the loaded (or empty) plate

            // Update analysis message based on load status and content
             const initialAnalysisMessage = loadedSuccessfully
                ? 'Plato cargado desde el almacenamiento local. Analiza para ver resultados.'
                : (savedData !== null ? 'Error al cargar, mostrando plato vac√≠o.' : 'No se encontr√≥ plato guardado.'); // More specific message

            analysisResultsDiv.innerHTML = `
                <h3 class="text-lg font-semibold mb-2 text-gray-700">An√°lisis del Plato y Recomendaciones:</h3>
                <p class="text-gray-600 italic">${initialAnalysisMessage} ${plateIsEmpty ? 'Selecciona alimentos y analiza.' : ''}</p>`;

            if (loadedSuccessfully) {
                showNotification('√öltimo plato guardado cargado.');
            }
        }


        function clearPlate() {
            console.log("[Clear Plate] Limpiando el plato."); // DEBUG
            currentPlate = { vegetables: [], fruits: [], grains: [], protein: [], oils: [], drinks: [] };
            renderPlate();
            analysisResultsDiv.innerHTML = `
                <h3 class="text-lg font-semibold mb-2 text-gray-700">An√°lisis del Plato y Recomendaciones:</h3>
                <p class="text-gray-600 italic">Plato limpiado. Selecciona alimentos y haz clic en "Analizar Plato".</p>`;
            caloriesInput.value = '';
            goalSelect.value = 'maintenance';
            for (const category in selectors) {
                if (selectors[category]) selectors[category].value = "";
            }
            showNotification('Plato limpiado.', 2000);
        }

        /** Generates a PDF containing only the plate and analysis results. */
        function printToPDF() {
            console.log("[Print PDF] Iniciando generaci√≥n de PDF..."); // DEBUG
            // Check if jsPDF and html2canvas libraries are loaded
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined' || typeof html2canvas === 'undefined') {
                console.error("[Print PDF] Error: jsPDF or html2canvas library not loaded.");
                showNotification("Error: No se pudo encontrar la librer√≠a para generar PDF.", 4000, true);
                return;
            }
            const { jsPDF } = window.jspdf; // Destructure jsPDF constructor

            // Elements to capture (the main container holding plate and analysis)
            const areaToPrint = document.getElementById('printable-area');
             if (!areaToPrint) {
                 console.error("[Print PDF] Error: Printable area element (#printable-area) not found.");
                 showNotification("Error: No se encontr√≥ el √°rea para imprimir.", 4000, true);
                 return;
             }

            // Elements to temporarily hide within the printable area
            const buttonsToHide = areaToPrint.querySelectorAll('.plate-section ul button, .side-section ul button'); // Include side section buttons just in case
            const oilsSection = document.getElementById('oils-side-section'); // Get oils section
            const drinksSection = document.getElementById('drinks-side-section'); // Get drinks section

            // --- Hide elements before capture ---
            console.log("[Print PDF] Ocultando elementos no deseados..."); // DEBUG
            buttonsToHide.forEach(btn => btn.style.visibility = 'hidden');
            let oilsOriginalDisplay = ''; // Store original display style
            let drinksOriginalDisplay = '';
            if (oilsSection) {
                oilsOriginalDisplay = oilsSection.style.display; // Store original
                oilsSection.style.display = 'none'; // Hide oils section
                console.log("[Print PDF] Secci√≥n de aceites oculta."); // DEBUG
            } else {
                 console.warn("[Print PDF] Secci√≥n de aceites no encontrada."); // DEBUG
            }
            if (drinksSection) {
                drinksOriginalDisplay = drinksSection.style.display; // Store original
                drinksSection.style.display = 'none'; // Hide drinks section
                console.log("[Print PDF] Secci√≥n de bebidas oculta."); // DEBUG
            } else {
                console.warn("[Print PDF] Secci√≥n de bebidas no encontrada."); // DEBUG
            }
            // ---

            console.log("[Print PDF] Capturando √°rea con html2canvas..."); // DEBUG
            // Use html2canvas to capture the modified printable area
            html2canvas(areaToPrint, {
                scale: 2, // Increase scale for better resolution
                useCORS: true,
                logging: false // Disable html2canvas console logging
             })
            .then(canvas => {
                console.log("[Print PDF] Captura de canvas exitosa. Generando PDF..."); // DEBUG
                // --- PDF Generation Logic ---
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });

                const imgProps = pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const margin = 40; // Page margin
                const headerHeight = 40; // Space for title
                const availableWidth = pdfWidth - 2 * margin;
                const availableHeight = pdfHeight - 2 * margin - headerHeight;

                // Calculate image dimensions to fit PDF page
                let ratio = Math.min(availableWidth / imgProps.width, availableHeight / imgProps.height);
                let finalImgWidth = imgProps.width * ratio;
                let finalImgHeight = imgProps.height * ratio;
                let xPos = (pdfWidth - finalImgWidth) / 2; // Center horizontally
                let yPos = margin + headerHeight; // Position below title

                // Add title and image to PDF
                pdf.setFontSize(18);
                pdf.text("Resumen de Mi Plato Interactivo", pdfWidth / 2, margin + 10, { align: 'center' });
                pdf.addImage(imgData, 'PNG', xPos, yPos, finalImgWidth, finalImgHeight);

                pdf.save('mi-plato-interactivo.pdf'); // Save the PDF
                console.log("[Print PDF] PDF guardado."); // DEBUG
                showNotification('PDF generado correctamente.', 3000);

            }).catch(err => {
                console.error("[Print PDF] Error generating PDF:", err); // DEBUG
                showNotification("Error al generar el PDF. Revisa la consola para m√°s detalles.", 4000, true);
            }).finally(() => {
                // --- Make elements visible again ---
                console.log("[Print PDF] Restaurando visibilidad de elementos ocultos..."); // DEBUG
                buttonsToHide.forEach(btn => btn.style.visibility = 'visible');
                if (oilsSection) {
                    oilsSection.style.display = oilsOriginalDisplay; // Restore original display
                    console.log("[Print PDF] Secci√≥n de aceites restaurada."); // DEBUG
                }
                if (drinksSection) {
                    drinksSection.style.display = drinksOriginalDisplay; // Restore original display
                     console.log("[Print PDF] Secci√≥n de bebidas restaurada."); // DEBUG
                }
                console.log("[Print PDF] Proceso de impresi√≥n finalizado."); // DEBUG
                // ---
            });
        }


        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("[Init] DOM completamente cargado y parseado."); // DEBUG
            populateSelectors();
            loadPlate(); // Load saved data (handles rendering)

            if (analyzeBtn) analyzeBtn.addEventListener('click', analyzePlate);
            else console.error("Analyze button not found");
            if (saveBtn) saveBtn.addEventListener('click', savePlate);
            else console.error("Save button not found");
            if (loadBtn) loadBtn.addEventListener('click', loadPlate);
            else console.error("Load button not found");
            if (printBtn) printBtn.addEventListener('click', printToPDF);
            else console.error("Print button not found");
            if (clearBtn) clearBtn.addEventListener('click', clearPlate);
            else console.error("Clear button not found");

            if (caloriesInput && analyzeBtn) {
                caloriesInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') analyzePlate();
                });
            }
            console.log("[Init] Inicializaci√≥n completada y listeners a√±adidos."); // DEBUG
        });

    </script>

</body>
</html>
